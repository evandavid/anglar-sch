"use strict";angular.module("angularApp",["ngSanitize","ui.router","LocalStorageModule","restangular","angularjs-datetime-picker","ngMask"]).config(["localStorageServiceProvider","RestangularProvider","$httpProvider",function(a,b,c){var d=window.location.hostname;d="localhost"===d?"":d,a.setPrefix("angular").setStorageType("sessionStorage").setStorageCookieDomain(d),b.setBaseUrl("http://expressnode.azurewebsites.net/api"),c.interceptors.push("APIInterceptor")}]).service("APIInterceptor",["$rootScope","localStorageService","$q","$injector",function(a,b,c,d){var e=this;e.request=function(d){d.params||(d.params={});var e=null;return e=null===a.token||void 0===a.token?b.get("token"):a.token,d.params.token=e,d||c.when(d)},e.responseError=function(a){return 401===a.status||403===a.status?(b.set("token",null),d.get("$state").transitionTo("auth"),c.reject(a)):c.reject(a)},e.response=function(a){return a}}]).run(["$rootScope","$state","$stateParams","Authorization","Cancan","$window",function(a,b,c,d,e,f){a.$on("$stateChangeStart",function(b,c,f){a.toState=c,a.toStateParams=f,a.search=null,a.page=1,e.isIdentityResolved()&&d.authorize()}),a.$on("$stateChangeSuccess",function(){f.scrollTo(0,0)})}]),angular.module("angularApp").controller("AuthCtrl",["$rootScope","Authentication","localStorageService","$state",function(a,b,c,d){function e(){h.logginIn=!h.logginIn}function f(){c.get("token")&&d.go("app.restricted.dashboard")}function g(){e(),h.errorLogin=null,b.authenticate(h.user).then(function(b){a.token=b.token,c.set("token",b.token),console.clear(),d.go("app.restricted.dashboard"),e()},function(a){h.errorLogin=a.data.message,e()})}var h=this;f(),h.doLogin=g}]),angular.module("angularApp").controller("MainCtrl",["$rootScope","currentUser","localStorageService","$state","Job",function(a,b,c,d,e){function f(){"user"===b.roles[0]&&e.getAll("","","",b.id,new Date).then(function(b){a.todaysJob=b.jobs,b.jobs.length&&jQuery("#modalJob").modal("show")})}a.currentUser=b,a.logout=function(){c.set("token",null),d.go("auth")},a.pageCount=function(a){return Math.ceil(a/10)},a.range=function(a,b,c){c=c||1;for(var d=[],e=a;b>=e;e+=c)d.push(e);return d},f()}]),angular.module("angularApp").controller("UsersCtrl",["User","Role","$timeout",function(a,b,c){function d(){n.filter={},n.filter.name="",n.filter.username=""}function e(){n.showForm=!0,n.formError=null,n.formSuccess=null}function f(){e()}function g(){n.showForm=!1,n.selectedUser={},n.processing=!1}function h(b){var c=b||!1;n.loadData=!0,c||(n.deleteId=null),a.getAll(n.filter.name,n.filter.username,n.currentPage).then(function(a){n.loadData=!1,n.users=a.users,n.totalPage=a.total})}function i(b){function d(){n.formSuccess=!0,c(function(){g(),h()},600)}n.formError=null,n.processing=!0,b.id?a.update(b).then(function(){d()},function(a){n.formError=a.data.message,n.processing=!1}):a.create(b).then(function(){d()},function(a){n.formError=a.data.message,n.processing=!1})}function j(){b.getAll().then(function(a){n.roles=a.roles})}function k(a){e(),c(function(){n.selectedUser=angular.copy(a),a.Roles&&a.Roles[0]&&(n.selectedUser.roleId=a.Roles[0].id),delete n.selectedUser.Roles})}function l(b){n.deleteId=b,a["delete"](b).then(function(a){a.success&&h(!0)})}function m(){a.undelete(n.deleteId).then(function(a){a.success&&h()})}var n=this;n.selectedUser={},n.selectedUser.isActive=!0,n.currentPage=1,d(),j(),h(),n.undoDelete=m,n.editUser=k,n.getForm=f,n.closeForm=g,n.refresh=h,n.submitForm=i,n.clrFilter=d,n.deleteUser=l}]),angular.module("angularApp").controller("ServicesCtrl",["Service","$timeout",function(a,b){function c(a){for(var b=angular.copy(a),c=[],d=2;b.length>0;)c.push(b.splice(0,d));return c}function d(){o.filter={},o.filter.name="",o.filter.username=""}function e(){o.showForm=!0,o.formError=null,o.formSuccess=null}function f(){e()}function g(){o.showForm=!1,o.selectedData={},o.processing=!1}function h(b){var d=b||!1;o.loadData=!0,d||(o.deleteId=null),a.getAll(o.filter.name,o.currentPage).then(function(a){if(o.loadData=!1,o.services=a.services,o.services&&o.services.length)for(var b=0;b<o.services.length;b++)o.services[b].Tasks&&o.services[b].Tasks.length&&(o.services[b].chunkTasks=c(o.services[b].Tasks));o.totalPage=a.total})}function i(c){function d(){o.formSuccess=!0,b(function(){g(),h()},600)}if(o.formError=null,o.processing=!0,!c.isPackage){c.price=0;for(var e=0;e<c.Tasks.length;e++)c.price+=isNaN(parseInt(c.Tasks[e].price))?0:parseInt(c.Tasks[e].price)}c.id?a.update(c).then(function(){d()},function(a){o.formError=a.data.message,o.processing=!1}):a.create(c).then(function(){d()},function(a){o.formError=a.data.message,o.processing=!1})}function j(a){e(),b(function(){o.selectedData=angular.copy(a),delete o.selectedData.Roles})}function k(b){o.deleteId=b,a["delete"](b).then(function(a){a.success&&h(!0)})}function l(){a.undelete(o.deleteId).then(function(a){a.success&&h()})}function m(){o.selectedData.Tasks||(o.selectedData.Tasks=[]),o.selectedData.Tasks.push({name:"",price:0})}function n(a){o.selectedData.Tasks.length&&o.selectedData.Tasks.splice(a,1)}var o=this;o.selectedData={},o.currentPage=1,d(),h(),o.removeTask=n,o.addTask=m,o.undoDelete=l,o.edit=j,o.getForm=f,o.closeForm=g,o.refresh=h,o.submitForm=i,o.clrFilter=d,o["delete"]=k}]),angular.module("angularApp").controller("JobsCtrl",["Job","$timeout","Batch","$rootScope",function(a,b,c,d){function e(a){if(void 0!==a&&null!==a&&""!==a){var b=a.split(" ")[0].split("-"),c=a.split(" ")[1].split(":");return{year:parseInt(b[2]),month:parseInt(b[1])-1,day:parseInt(b[0]),hour:parseInt(c[0]),minute:parseInt(c[1])}}return null}function f(a){return new Date(a.year,a.month,a.day,a.hour,a.minute)}function g(a){var b=new Date(a);return b.getDate()+"-"+(b.getMonth()+1)+"-"+b.getFullYear()+" "+b.getHours()+":"+b.getMinutes()}function h(){c.execute({users:"/api/users/all",services:"/api/services/all"}).then(function(a){if(u.users=[],a.users&&a.users.users&&a.users.users.length)for(var b=0;b<a.users.users.length;b++){var c=a.users.users[b];"superadmin"!==c.Roles[0].name&&u.users.push(c)}u.services=a.services.services})}function i(){u.filter={},u.filter.name="",u.filter.username="",u.filter.maidName=""}function j(){u.showForm=!0,u.formError=null,u.formSuccess=null}function k(){j()}function l(){u.showForm=!1,u.selectedData={},u.processing=!1}function m(b){var c=b||!1;u.loadData=!0,c||(u.deleteId=null);var e=0;"user"===d.currentUser.roles[0]&&(e=d.currentUser.id),a.getAll(u.filter.name,u.currentPage,u.filter.maidName,e).then(function(a){u.loadData=!1,u.jobs=a.jobs,u.totalPage=a.total})}function n(c){function d(){u.formSuccess=!0,b(function(){l(),m()},600)}var g=angular.copy(c);u.formError=null,u.processing=!0;var h=e(g.startTime);h&&(g.startTime=f(h));var i=e(g.endTime);i&&(g.endTime=f(i)),g.id?a.update(g).then(function(){d()},function(a){u.formError=a.data.message,u.processing=!1}):a.create(g).then(function(){d()},function(a){u.formError=a.data.message,u.processing=!1})}function o(a){j(),b(function(){u.selectedData=angular.copy(a),u.selectedData.endTime=g(u.selectedData.endTime),u.selectedData.startTime=g(u.selectedData.startTime)})}function p(b){u.deleteId=b,a["delete"](b).then(function(a){a.success&&m(!0)})}function q(){a.undelete(u.deleteId).then(function(a){a.success&&m()})}function r(){u.selectedData.Tasks||(u.selectedData.Tasks=[]),u.selectedData.Tasks.push({name:"",price:0})}function s(a){u.selectedData.Tasks.length&&u.selectedData.Tasks.splice(a,1)}function t(a){var c=_.find(u.services,{id:parseInt(a)});b(function(){u.selectedData.service=c})}var u=this;u.selectedData={},u.currentPage=1,h(),i(),m(),u.removeTask=s,u.addTask=r,u.undoDelete=q,u.edit=o,u.getForm=k,u.closeForm=l,u.refresh=m,u.submitForm=n,u.clrFilter=i,u["delete"]=p,u.setService=t}]),angular.module("angularApp").controller("CalendarsCtrl",["Job","$rootScope","$timeout",function(a,b,c){function d(a){var b=[];return _.each(a,function(a){b.push({title:"Client: "+a.Client.name+"<br />Address: "+a.Client.address+"<br />Maid: "+a.User.name,start:a.startTime,end:a.endTime,id:a.id})}),b}function e(a){var b=void 0!==a?a.format("YYYY-MM-DD"):moment().format("YYYY-MM-DD");c(function(){jQuery("#calendar").fullCalendar({header:{left:"prev,next",center:"title",right:"prev,next"},editable:!1,eventStartEditable:!1,defaultDate:b,events:i.events,nextDayThreshold:"00:00:00",eventRender:function(a,b){b.find("span.fc-title").html(b.find("span.fc-title").text())},eventClick:function(a){c(function(){i.job=_.find(i.jobs,{id:a.id})}),jQuery("#modalCal").modal("show")}})},0)}function f(c,f){i.gettingData=!0;var g=0;"user"===b.currentUser.roles[0]&&(g=b.currentUser.id),a.getAll("","","",g,c,f).then(function(a){jQuery("#calendar").fullCalendar("removeEvents"),i.jobs=angular.copy(a.jobs),i.events=d(a.jobs),i.isInitiate?jQuery("#calendar").fullCalendar("addEventSource",i.events):(i.isInitiate=!0,e(moment(c))),i.gettingData=!1})}function g(a){var b=new Date(a.year(),a.month(),1),c=new Date(a.year(),a.month()+1,0);f(b,c)}function h(){var a=new Date;g(moment(a))}var i=this;jQuery("body").on("click.myEvent","button.fc-prev-button",function(){var a=jQuery("#calendar").fullCalendar("getDate");g(a)}),jQuery("body").on("click.myEvent","button.fc-next-button",function(){var a=jQuery("#calendar").fullCalendar("getDate");g(a)}),h()}]),angular.module("angularApp").factory("Authentication",["Restangular",function(a){return{authenticate:function(b){return a.all("authenticate").customPOST(b,null,{},{})}}}]),angular.module("angularApp").factory("Authorization",["$rootScope","$state","Cancan",function(a,b,c){return{authorize:function(){return c.identity().then(function(){var d=c.isAuthenticated();void 0!==a.toState.data&&a.toState.data.roles&&a.toState.data.roles.length>0&&!c.isInAnyRole(a.toState.data.roles)&&(d?b.go("app.restricted.dashboard"):(a.returnToState=a.toState,a.returnToStateParams=a.toStateParams,b.go("auth")))})}}}]),angular.module("angularApp").factory("Cancan",["$q","$http","User",function(a,b,c){var d=void 0,e=!1;return{isIdentityResolved:function(){return angular.isDefined(d)},isAuthenticated:function(){return e},isInRole:function(a){return e&&d.roles?-1!==d.roles.indexOf(a):!1},isInAnyRole:function(a){if(!d)return!1;if(!e||!d.roles)return!1;for(var b=0;b<a.length;b++)if(this.isInRole(a[b]))return!0;return!1},authenticate:function(a){d=a,e=null!==a},identity:function(b){var f=a.defer();return b===!0&&(d=void 0),angular.isDefined(d)?(f.resolve(d),f.promise):(c.me().then(function(a){d=a.user,e=!0,f.resolve(d)},function(){d=null,e=!1,f.resolve(d)}),f.promise)}}}]),angular.module("angularApp").factory("User",["Restangular",function(a){return{me:function(){return a.one("users/me").get()},create:function(b){return a.all("users/create").customPOST({user:b},null,{},{})},update:function(b){return a.all("users/update").customPOST({user:b},null,{},{})},"delete":function(b){return a.all("users").customDELETE("delete?userId="+b,{})},undelete:function(b){return a.all("users/undelete").customPOST({userId:b},null,{},{})},getAll:function(b,c,d){return a.one("users/all?filterName="+b+"&filterUsername="+c+"&page="+d).get()}}}]),angular.module("angularApp").factory("Role",["Restangular",function(a){return{getAll:function(){return a.one("roles/all").get()}}}]),angular.module("angularApp").factory("Service",["Restangular",function(a){return{me:function(){return a.one("services/me").get()},create:function(b){return a.all("services/create").customPOST({service:b},null,{},{})},update:function(b){return a.all("services/update").customPOST({service:b},null,{},{})},"delete":function(b){return a.all("services").customDELETE("delete?id="+b,{})},undelete:function(b){return a.all("services/undelete").customPOST({id:b},null,{},{})},getAll:function(b,c){return a.one("services/all?filterName="+b+"&page="+c).get()}}}]),angular.module("angularApp").factory("Job",["Restangular",function(a){return{me:function(){return a.one("jobs/me").get()},create:function(b){return a.all("jobs/create").customPOST({job:b},null,{},{})},update:function(b){return a.all("jobs/update").customPOST({job:b},null,{},{})},"delete":function(b){return a.all("jobs").customDELETE("delete?id="+b,{})},undelete:function(b){return a.all("jobs/undelete").customPOST({id:b},null,{},{})},getAll:function(b,c,d,e,f,g){var h=f||0,i=g||0;return a.one("jobs/all?filterName="+b+"&page="+c+"&maidName="+d+"&userId="+e+"&startAt="+h+"&endAt="+i).get()}}}]),angular.module("angularApp").factory("Batch",["Restangular",function(a){return{execute:function(b){var c=jQuery.param(b);return a.one("batch?"+c).get()}}}]),angular.module("angularApp").directive("checkMenuAuthorized",["$state","Cancan",function(a,b){return{restrict:"A",link:function(c,d){var e=jQuery(d),f=e.attr("ui-sref"),g=a.get(f);void 0!==g.data&&g.data.roles&&g.data.roles.length>0&&!b.isInAnyRole(g.data.roles)?e.hide():e.show()}}}]),angular.module("angularApp").config(["$stateProvider","$urlRouterProvider",function(a,b){b.otherwise("/dashboard"),b.when("","/dashboard"),a.state("auth",{url:"/login",templateUrl:"views/auth/index.html",controller:"AuthCtrl",controllerAs:"vm"}).state("app",{url:"","abstract":!0,templateUrl:"views/layouts/application.html",controller:"MainCtrl",params:{token:null},resolve:{currentUser:["Cancan",function(a){return a.identity(!0)}]}}).state("app.restricted",{url:"","abstract":!0,templateUrl:"views/layouts/application.html",resolve:{authorize:["Authorization",function(a){return a.authorize()}]}}).state("app.restricted.dashboard",{url:"/dashboard",templateUrl:"views/dashboards/index.html",controllerAs:"vm",data:{roles:["superadmin","user"]}}).state("app.restricted.users",{url:"/users",templateUrl:"views/users/index.html",controller:"UsersCtrl",controllerAs:"vm",data:{roles:["superadmin"]}}).state("app.restricted.services",{url:"/services",templateUrl:"views/services/index.html",controller:"ServicesCtrl",controllerAs:"vm",data:{roles:["superadmin"]}}).state("app.restricted.jobs",{url:"/jobs",templateUrl:"views/jobs/index.html",controller:"JobsCtrl",controllerAs:"vm",data:{roles:["superadmin","user"]}}).state("app.restricted.calendars",{url:"/calendars",templateUrl:"views/calendars/index.html",controller:"CalendarsCtrl",controllerAs:"vm",data:{roles:["superadmin","user"]},onExit:function(){jQuery(".ui.dimmer.modals").remove()}})}]);